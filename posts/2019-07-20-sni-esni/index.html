<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>SNI and ESNI | David Zhu | Blog</title>
<meta name=keywords content="Network,Web,Security,Privacy">
<meta name=description content="Prelude I have a DNS resolver setup at home which my home devices use and set it to use DNS over TLS (DoT) to resolve queries so ISPs and such can&rsquo;t see the domains I&rsquo;m visiting, but SNI is leaking out the sites I&rsquo;m visiting and there&rsquo;s nothing much I can do about it for now. ðŸ˜£
What is the Purpose of SNI Problem  Name-based virtual hosting allows multiple DNS hostnames to be hosted by a single server (usually a web server) on the same IP address.">
<meta name=author content="David">
<link rel=canonical href=https://dzhy.dev/posts/2019-07-20-sni-esni/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://dzhy.dev/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://dzhy.dev/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://dzhy.dev/favicon-32x32.png>
<link rel=apple-touch-icon href=https://dzhy.dev/apple-touch-icon.png>
<link rel=mask-icon href=https://dzhy.dev/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.89.4">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript>
<meta property="og:title" content="SNI and ESNI">
<meta property="og:description" content="Prelude I have a DNS resolver setup at home which my home devices use and set it to use DNS over TLS (DoT) to resolve queries so ISPs and such can&rsquo;t see the domains I&rsquo;m visiting, but SNI is leaking out the sites I&rsquo;m visiting and there&rsquo;s nothing much I can do about it for now. ðŸ˜£
What is the Purpose of SNI Problem  Name-based virtual hosting allows multiple DNS hostnames to be hosted by a single server (usually a web server) on the same IP address.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://dzhy.dev/posts/2019-07-20-sni-esni/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2019-07-20T00:00:00+00:00">
<meta property="article:modified_time" content="2019-07-20T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="SNI and ESNI">
<meta name=twitter:description content="Prelude I have a DNS resolver setup at home which my home devices use and set it to use DNS over TLS (DoT) to resolve queries so ISPs and such can&rsquo;t see the domains I&rsquo;m visiting, but SNI is leaking out the sites I&rsquo;m visiting and there&rsquo;s nothing much I can do about it for now. ðŸ˜£
What is the Purpose of SNI Problem  Name-based virtual hosting allows multiple DNS hostnames to be hosted by a single server (usually a web server) on the same IP address.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dzhy.dev/posts/"},{"@type":"ListItem","position":2,"name":"SNI and ESNI","item":"https://dzhy.dev/posts/2019-07-20-sni-esni/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SNI and ESNI","name":"SNI and ESNI","description":"Prelude I have a DNS resolver setup at home which my home devices use and set it to use DNS over TLS (DoT) to resolve queries so ISPs and such can\u0026rsquo;t see the domains I\u0026rsquo;m visiting, but SNI is leaking out the sites I\u0026rsquo;m visiting and there\u0026rsquo;s nothing much I can do about it for now. ðŸ˜£\nWhat is the Purpose of SNI Problem  Name-based virtual hosting allows multiple DNS hostnames to be hosted by a single server (usually a web server) on the same IP address.","keywords":["Network","Web","Security","Privacy"],"articleBody":"Prelude I have a DNS resolver setup at home which my home devices use and set it to use DNS over TLS (DoT) to resolve queries so ISPs and such canâ€™t see the domains Iâ€™m visiting, but SNI is leaking out the sites Iâ€™m visiting and thereâ€™s nothing much I can do about it for now. ðŸ˜£\nWhat is the Purpose of SNI Problem  Name-based virtual hosting allows multiple DNS hostnames to be hosted by a single server (usually a web server) on the same IP address. To achieve this, the server uses a hostname presented by the client as part of the protocol (for HTTP the name is presented in the host header). Source\n However, when using HTTPS, the TLS connection happens before the sending of any HTTP data, so we need another way of letting the server know which host we are connecting to so it can establish the TLS connection with the correct certificate.\nSolution Server Name Indication (SNI) solves this by having the client send the hostname as part of the TLS handshake. This enables the server to establish the TLS connection with the correct certificate.\nThe hostname sent during TLS handshake is not encrypted, so eavesdroppers for example ISPs can see which sites you are visiting.\nHereâ€™s a diagram to illustrate. ðŸ”’ Means that it is encrypted. sequenceDiagram\rClient-Server: ClientHello + SNI\rServer-Client: ServerHello\rClient-Server: FinishedðŸ”’\rClient-Server: HTTP RequestðŸ”’\rServer-Client: HTTP ResponseðŸ”’\r I have written a SNI Sniffer (only tested on linux) to see this in effect, the code quality is pretty bad Iâ€™ll update it when I have time.\nâžœ sudo sni-sniffer -s eth0\rStarted capturing on ens33\rTCP V4(192.168.14.128):50596 - V4(172.217.27.46):443\rSNI: [\r\"google.com\",\r]\rTCP V4(192.168.14.128):51262 - V4(117.18.232.200):443\rSNI: [\r\"az764295.vo.msecnd.net\",\r]\rTCP V4(192.168.14.128):45508 - V4(111.221.29.254):443\rSNI: [\r\"vortex.data.microsoft.com\",\r]\rTCP V4(192.168.14.128):40952 - V4(172.217.160.10):443\rSNI: [\r\"safebrowsing.googleapis.com\",\r]\rTCP V4(192.168.14.128):37934 - V4(35.166.72.120):443\rSNI: [\r\"shavar.services.mozilla.com\",\r]\rESNIðŸ”’ Encrypted SNI is an extension to TLS 1.3 and above which encrypts the SNI so eavesdroppers cannot see which sites you are visiting.\nThe general idea of how ESNI works is the server publishes a public key on as a DNS record, which can be fetched by the client before connecting. The client then encrypts the SNI extension using a symmetric encryption key derived using the serverâ€™s public key. The server can then decrypt it by deriving the same symmetric encryption key using itâ€™s private key.\nFor now the only browser I know that supports ESNI is Firefox, but it is not enabled by default, you have to enable it yourself, by going to about:config and setting network.security.esni.enabled to true.\nThe problem now is the server you are connecting to has to support ESNI as well, and there isnâ€™t much support for it software wise as the specifications for ESNI is still in draft. Even when the software support is there, most people are probably lazy to setup ESNI for their servers, currently the best/easiest solution is to use cloudflare as a reverse proxy as they have ESNI enabled by default.\nHopefully specifications for ESNI will be firmed up soon and more sites and browsers will start using ESNI.\n","wordCount":"524","inLanguage":"en","datePublished":"2019-07-20T00:00:00Z","dateModified":"2019-07-20T00:00:00Z","author":{"@type":"Person","name":"David"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dzhy.dev/posts/2019-07-20-sni-esni/"},"publisher":{"@type":"Organization","name":"David Zhu | Blog","logo":{"@type":"ImageObject","url":"https://dzhy.dev/favicon.ico"}}}</script>
</head>
<body class=dark id=top>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://dzhy.dev/ accesskey=h title="David Zhu | Blog (Alt + H)">David Zhu | Blog</a>
<span class=logo-switches>
</span>
</div>
<ul id=menu>
<li>
<a href=https://dzhy.dev/about/ title=about>
<span>about</span>
</a>
</li>
<li>
<a href=https://dzhy.dev/archive/ title=archive>
<span>archive</span>
</a>
</li>
<li>
<a href=https://dzhy.dev/tags/ title=tags>
<span>tags</span>
</a>
</li>
<li>
<a href=https://dzhy.dev/search/ title="search (Alt + /)" accesskey=/>
<span>search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://dzhy.dev/>Home</a>&nbsp;Â»&nbsp;<a href=https://dzhy.dev/posts/>Posts</a></div>
<h1 class=post-title>
SNI and ESNI
</h1>
<div class=post-meta><span title="2019-07-20 00:00:00 +0000 UTC">July 20, 2019</span>&nbsp;Â·&nbsp;3 min&nbsp;Â·&nbsp;David
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#prelude aria-label=Prelude>Prelude</a></li>
<li>
<a href=#what-is-the-purpose-of-sni aria-label="What is the Purpose of SNI">What is the Purpose of SNI</a><ul>
<li>
<a href=#problem aria-label=Problem>Problem</a></li>
<li>
<a href=#solution aria-label=Solution>Solution</a></li></ul>
</li>
<li>
<a href=#esni aria-label=ESNIðŸ”’>ESNIðŸ”’</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h2 id=prelude>Prelude<a hidden class=anchor aria-hidden=true href=#prelude>#</a></h2>
<p>I have a DNS resolver setup at home which my home devices use and set it to use DNS over TLS (DoT) to resolve queries so ISPs and such can&rsquo;t see the domains I&rsquo;m visiting, but SNI is leaking out the sites I&rsquo;m visiting and there&rsquo;s nothing much I can do about it for now. ðŸ˜£</p>
<h2 id=what-is-the-purpose-of-sni>What is the Purpose of SNI<a hidden class=anchor aria-hidden=true href=#what-is-the-purpose-of-sni>#</a></h2>
<h3 id=problem>Problem<a hidden class=anchor aria-hidden=true href=#problem>#</a></h3>
<blockquote>
<p>Name-based virtual hosting allows multiple DNS hostnames to be hosted by a single server (usually a web server) on the same IP address. To achieve this, the server uses a hostname presented by the client as part of the protocol (for HTTP the name is presented in the host header). <a href=https://en.wikipedia.org/wiki/Server_Name_Indication>Source</a></p>
</blockquote>
<p>However, when using HTTPS, the TLS connection happens before the sending of any HTTP data, so we need another way of letting the server know which host we are connecting to so it can establish the TLS connection with the correct certificate.</p>
<h3 id=solution>Solution<a hidden class=anchor aria-hidden=true href=#solution>#</a></h3>
<p>Server Name Indication (SNI) solves this by having the client send the hostname as part of the TLS handshake. This enables the server to establish the TLS connection with the correct certificate.</p>
<p>The hostname sent during TLS handshake is not encrypted, so eavesdroppers for example ISPs can see which sites you are visiting.</p>
<p>Here&rsquo;s a diagram to illustrate. ðŸ”’ Means that it is encrypted.
<div class=mermaid align=center>
sequenceDiagram
Client->>Server: ClientHello + SNI
Server->>Client: ServerHello
Client->>Server: FinishedðŸ”’
Client->>Server: HTTP RequestðŸ”’
Server->>Client: HTTP ResponseðŸ”’
</div>
</p>
<p>I have written a <a href=https://github.com/PotatoDrug/SNI-Sniffer>SNI Sniffer</a> (only tested on linux) to see this in effect, the code quality is pretty bad I&rsquo;ll update it when I have time.</p>
<pre tabindex=0><code>âžœ sudo sni-sniffer -s eth0
Started capturing on ens33
TCP V4(192.168.14.128):50596 -&gt; V4(172.217.27.46):443
SNI: [
    &quot;google.com&quot;,
]
TCP V4(192.168.14.128):51262 -&gt; V4(117.18.232.200):443
SNI: [
    &quot;az764295.vo.msecnd.net&quot;,
]
TCP V4(192.168.14.128):45508 -&gt; V4(111.221.29.254):443
SNI: [
    &quot;vortex.data.microsoft.com&quot;,
]
TCP V4(192.168.14.128):40952 -&gt; V4(172.217.160.10):443
SNI: [
    &quot;safebrowsing.googleapis.com&quot;,
]
TCP V4(192.168.14.128):37934 -&gt; V4(35.166.72.120):443
SNI: [
    &quot;shavar.services.mozilla.com&quot;,
]
</code></pre><h2 id=esni>ESNIðŸ”’<a hidden class=anchor aria-hidden=true href=#esni>#</a></h2>
<p>Encrypted SNI is an extension to TLS 1.3 and above which encrypts the SNI so eavesdroppers cannot see which sites you are visiting.</p>
<p>The general idea of how ESNI works is the server publishes a public key on as a DNS record, which can be fetched by the client before connecting. The client then encrypts the SNI extension using a symmetric encryption key derived using the server&rsquo;s public key. The server can then decrypt it by deriving the same symmetric encryption key using it&rsquo;s private key.</p>
<p>For now the only browser I know that supports ESNI is Firefox, but it is not enabled by default, you have to enable it yourself, by going to <code>about:config</code> and setting <code>network.security.esni.enabled</code> to true.</p>
<p>The problem now is the server you are connecting to has to support ESNI as well, and there isn&rsquo;t much support for it software wise as the specifications for ESNI is still in draft. Even when the software support is there, most people are probably lazy to setup ESNI for their servers, currently the best/easiest solution is to use cloudflare as a reverse proxy as they have ESNI enabled by default.</p>
<p>Hopefully specifications for ESNI will be firmed up soon and more sites and browsers will start using ESNI.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://dzhy.dev/tags/network/>Network</a></li>
<li><a href=https://dzhy.dev/tags/web/>Web</a></li>
<li><a href=https://dzhy.dev/tags/security/>Security</a></li>
<li><a href=https://dzhy.dev/tags/privacy/>Privacy</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://dzhy.dev/posts/2020-02-28-understanding-rabin2-output/>
<span class=title>Â« Prev Page</span>
<br>
<span>Understanding rabin2 output</span>
</a>
<a class=next href=https://dzhy.dev/posts/2019-06-14-cddc-2019-lscvm-writeup/>
<span class=title>Next Page Â»</span>
<br>
<span>CDDC 2019 LSCVM Writeup</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://dzhy.dev/>David Zhu | Blog</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script>mermaid.initialize({startOnLoad:!0,theme:'dark'})</script>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>